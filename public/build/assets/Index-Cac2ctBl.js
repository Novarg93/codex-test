import{a as V,_ as X}from"./DefaultLayout.vue_vue_type_script_setup_true_lang-BTbjbBgZ.js";import{l as F,p,j as L,x as Q,s as j,g as a,o as r,b as e,k as Z,i as b,f as g,t as u,y as H,n as G,a as E,w as T,F as C,q as A,c as K}from"./app-KhPXK_eo.js";import{_ as W}from"./Input-C3EQsbHI.js";import{_ as Y}from"./SeoHead.vue_vue_type_script_setup_true_lang-Dh5GiDDG.js";import"./index-FV2GQg2N.js";var ee="basil",B="https://js.stripe.com",te="".concat(B,"/").concat(ee,"/stripe.js"),se=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,ne=/^https:\/\/js\.stripe\.com\/(v3|[a-z]+)\/stripe\.js(\?.*)?$/;var oe=function(l){return se.test(l)||ne.test(l)},re=function(){for(var l=document.querySelectorAll('script[src^="'.concat(B,'"]')),n=0;n<l.length;n++){var i=l[n];if(oe(i.src))return i}return null},D=function(l){var n="",i=document.createElement("script");i.src="".concat(te).concat(n);var o=document.head||document.body;if(!o)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return o.appendChild(i),i},N=null,$=null,q=null,ae=function(l){return function(n){l(new Error("Failed to load Stripe.js",{cause:n}))}},le=function(l,n){return function(){window.Stripe?l(window.Stripe):n(new Error("Stripe.js not available"))}},ie=function(l){return N!==null?N:(N=new Promise(function(n,i){if(typeof window>"u"||typeof document>"u"){n(null);return}if(window.Stripe){n(window.Stripe);return}try{var o=re();if(!(o&&l)){if(!o)o=D(l);else if(o&&q!==null&&$!==null){var v;o.removeEventListener("load",q),o.removeEventListener("error",$),(v=o.parentNode)===null||v===void 0||v.removeChild(o),o=D(l)}}q=le(n,i),$=ae(i),o.addEventListener("load",q),o.addEventListener("error",$)}catch(f){i(f);return}}),N.catch(function(n){return N=null,Promise.reject(n)}))},P,ue=function(){return P||(P=ie(null).catch(function(l){return P=null,Promise.reject(l)}),P)};Promise.resolve().then(function(){return ue()}).catch(function(y){console.warn(y)});const ce={class:"border rounded-lg p-4"},de={class:"block text-sm font-medium mb-2"},me={key:0,class:"text-xs text-muted-foreground ml-1"},pe={key:1,class:"text-xs text-red-600 ml-1"},ve={key:0,class:"mt-1 text-xs text-red-600"},fe={key:1,class:"mt-1 text-xs text-green-600"},_e={key:2,class:"mt-1 text-xs text-green-600"},ye={class:"mt-3"},be=["disabled"],xe=F({__name:"GameNicknameForm",props:{initialNickname:{},required:{type:Boolean},saveUrl:{},label:{},help:{}},setup(y,{expose:l}){const n=y,i=p(n.initialNickname??""),o=p(!1),v=p(!1),f=p(!1),d=p(null),x=L(()=>i.value.trim()===""),h=L(()=>(n.initialNickname??"")!==i.value),R=L(()=>(n.required??!1)&&x.value),k=L(()=>["block w-full text-white rounded-md border px-3 py-2 bg-input text-sm outline-none transition",R.value||d.value?"border-red-500 ring-1 ring-red-500 focus:ring-red-500":"border-border focus:ring-1 focus:ring-primary"].join(" "));Q(i,()=>{d.value=null,v.value=!1,f.value=!1}),l({submit:S});async function S(){if((n.required??!1)&&x.value){d.value="Type Nickname of your character";return}if(!o.value){o.value=!0;try{const m={nickname:x.value?null:i.value.trim()};await j.post(n.saveUrl,m),x.value?((n.initialNickname??"")!==""&&(f.value=!0),v.value=!1):(v.value=!0,f.value=!1),d.value=null}catch(m){const w=m?.response?.data?.message||"Error";d.value=w}finally{o.value=!1}}}return(m,w)=>(r(),a("div",ce,[e("label",de,[g(u(m.label??"Ник персонажа (в игре)")+" ",1),m.required?(r(),a("span",pe,"*")):(r(),a("span",me,"(not required)"))]),Z(e("input",{class:G(k.value),"onUpdate:modelValue":w[0]||(w[0]=I=>i.value=I),type:"text",inputmode:"text",autocapitalize:"none",autocomplete:"off",spellcheck:"false",placeholder:"MyNickName"},null,2),[[H,i.value,void 0,{trim:!0}]]),d.value?(r(),a("p",ve,u(d.value),1)):v.value?(r(),a("p",fe,"Saved")):f.value?(r(),a("p",_e,"Cleared")):b("",!0),e("div",ye,[e("button",{disabled:o.value||!h.value,class:"px-3 py-2 rounded-md bg-primary text-primary-foreground disabled:opacity-50",onClick:S},u(o.value?"Submitting...":"Submit"),9,be)])]))}}),ge={class:"w-[90%] 2xl:w-[75%] mx-auto py-8 md:py-12 lg:py-16"},ke={class:"grid lg:grid-cols-3 gap-6"},he={class:"lg:col-span-2 space-y-4"},we={class:"border rounded-lg p-4"},Se=["src"],Ee={class:"flex-1"},Ce={class:"font-medium"},Ne={key:0,class:"text-xs text-muted-foreground"},Pe={key:1,class:"text-xs text-muted-foreground"},je={key:2,class:"mt-1 text-xs text-muted-foreground"},Re={class:"list-disc pl-5 space-y-0.5"},Le={key:0,class:"text-[10px] mr-2 px-1.5 py-0.5 rounded bg-amber-100 text-amber-900 border border-amber-200"},$e={class:"font-medium"},qe={key:1,class:"ml-1"},Ie={class:"text-right"},Te={key:0,class:"text-sm"},Ue={class:"font-semibold"},Ve={class:"lg:col-span-1"},Ae={class:"border rounded-lg p-4 sticky top-6"},De={class:"space-y-2 text-sm"},Fe={class:"flex justify-between"},Ge={class:"flex justify-between"},Be={class:"flex justify-between"},Me={key:0,class:"flex justify-between text-green-700"},Oe={key:0},ze={class:"mt-3"},Je={class:"flex gap-2"},Xe={class:"mt-3 border-t pt-3 flex justify-between font-semibold"},Qe={key:1,disabled:"","aria-busy":"true",class:"w-full mt-4 px-4 py-2 rounded-lg bg-muted text-muted-foreground flex items-center justify-center gap-2"},Ze={key:3,disabled:"",class:"w-full mt-2 px-4 py-2 rounded-lg bg-muted text-muted-foreground"},tt=F({__name:"Index",props:{seo:{},stripePk:{},items:{},totals:{},promo:{},nickname:{}},setup(y){const l=p(!1),n=p(null),i=p(!1),o=y,v=p(""),f=p(!1),d=p(null),x=p(!1),h=p(o.promo??null);function R(t){const s=Number.isFinite(t?.discount_cents)?Number(t.discount_cents):0,c=Number(t?.subtotal_cents??0),_=Number(t?.shipping_cents??0),U=Number(t?.tax_cents??0),J=Number.isFinite(t?.total_cents)?Number(t.total_cents):Math.max(0,c+_+U-s);return{subtotal_cents:c,shipping_cents:_,tax_cents:U,discount_cents:s,total_cents:J,currency:String(t?.currency??o.totals.currency??"USD")}}const k=p(R(o.totals));function S(t){k.value=R(t)}function m(t){return new Intl.NumberFormat("en-US",{style:"currency",currency:k.value.currency??o.totals.currency}).format((t||0)/100)}function w(t){return t.calc_mode==="percent"?(t.value_percent??0)!==0:(t.value_cents??0)!==0}async function I(){if(!i.value){i.value=!0;try{n.value?.submit&&await n.value.submit();const{data:t}=await j.post("/checkout/test-pending");window.location.href=t?.redirect??route("orders.show",t.order_id)}catch(t){console.error("Create pending draft failed",t),i.value=!1}}}async function M(){if(v.value.trim()){f.value=!0,d.value=null;try{const{data:t}=await j.post("/checkout/promo/apply",{code:v.value});t.ok?(h.value=t.promo,S(t.totals),x.value=!0,d.value=`Applied ${t.promo.code}`):(x.value=!1,d.value=t.message??"Cannot apply code")}catch(t){x.value=!1,d.value=t?.response?.data?.message??"Cannot apply code"}finally{f.value=!1}}}async function O(){f.value=!0,d.value=null;try{const{data:t}=await j.post("/checkout/promo/remove");h.value=null,S(t.totals),x.value=!0,d.value="Removed"}catch{x.value=!1,d.value="Cannot remove"}finally{f.value=!1}}async function z(){if(!l.value){l.value=!0;try{n.value?.submit&&await n.value.submit();const{data:t}=await j.post("/checkout/dev-success");window.location.href=t?.redirect??route("orders.show",t.order_id)}catch(t){console.error("Dev success failed",t),l.value=!1}}}return(t,s)=>(r(),a(C,null,[E(Y,{seo:o.seo},null,8,["seo"]),E(X,null,{default:T(()=>[e("section",ge,[s[15]||(s[15]=e("h1",{class:"text-3xl font-semibold mb-6"},"Checkout",-1)),e("div",ke,[e("div",he,[e("div",we,[s[3]||(s[3]=e("h2",{class:"font-semibold mb-3"},"Items",-1)),(r(!0),a(C,null,A(o.items,c=>(r(),a("div",{key:c.id,class:"flex gap-4 border rounded-md p-3 mb-2"},[c.product.image_url?(r(),a("img",{key:0,src:c.product.image_url,class:"w-16 h-16 object-cover rounded"},null,8,Se)):b("",!0),e("div",Ee,[e("div",Ce,u(c.product.name),1),c.range_labels?.length?(r(),a("div",Ne,u(c.range_labels.join(", ")),1)):b("",!0),c.has_qty_slider?(r(),a("div",Pe," Qty: "+u(c.qty),1)):b("",!0),c.options?.length?(r(),a("div",je,[e("ul",Re,[(r(!0),a(C,null,A(c.options,_=>(r(),a("li",{key:_.id},[_.is_ga?(r(),a("span",Le," GA ")):b("",!0),e("span",$e,u(_.title),1),w(_)?(r(),a("span",qe,[s[1]||(s[1]=g(" ( ",-1)),_.calc_mode==="percent"?(r(),a(C,{key:0},[g(" +"+u(_.value_percent??0)+"% "+u(_.scope),1)],64)):(r(),a(C,{key:1},[g(u((_.value_cents??0)>=0?"+":"")+" "+u(m(_.value_cents??0))+" "+u(_.scope),1)],64)),s[2]||(s[2]=g(" ) ",-1))])):b("",!0)]))),128))])])):b("",!0)]),e("div",Ie,[c.has_qty_slider?(r(),a("div",Te,u(m(c.unit_price_cents))+" / each ",1)):b("",!0),e("div",Ue,u(m(c.line_total_cents)),1)])]))),128))])]),e("div",Ve,[E(xe,{ref_key:"nickFormRef",ref:n,"initial-nickname":o.nickname??"",required:!1,"save-url":"/checkout/nickname",label:"Character nickname for delivery",class:"mb-4"},null,8,["initial-nickname"]),e("div",Ae,[s[13]||(s[13]=e("h2",{class:"font-semibold mb-3"},"Summary",-1)),e("ul",De,[e("li",Fe,[s[4]||(s[4]=e("span",null,"Subtotal",-1)),e("span",null,u(m(k.value.subtotal_cents)),1)]),e("li",Ge,[s[5]||(s[5]=e("span",null,"Shipping",-1)),e("span",null,u(m(k.value.shipping_cents)),1)]),e("li",Be,[s[6]||(s[6]=e("span",null,"Tax",-1)),e("span",null,u(m(k.value.tax_cents)),1)]),(k.value.discount_cents??0)>0?(r(),a("li",Me,[e("span",null,[s[7]||(s[7]=g("Discount",-1)),h.value?.code?(r(),a("span",Oe," ("+u(h.value.code)+")",1)):b("",!0)]),e("span",null,"-"+u(m(k.value.discount_cents)),1)])):b("",!0)]),e("div",ze,[s[10]||(s[10]=e("label",{class:"block text-sm font-medium mb-1"},"Promo code",-1)),e("div",Je,[E(W,{modelValue:v.value,"onUpdate:modelValue":s[0]||(s[0]=c=>v.value=c),type:"text",placeholder:"ENTER CODE",class:"flex-1 border rounded-lg px-3 py-2"},null,8,["modelValue"]),E(V,{class:"px-3 py-2 border rounded-lg",onClick:M,disabled:f.value},{default:T(()=>[...s[8]||(s[8]=[g(" Apply ",-1)])]),_:1},8,["disabled"]),h.value?.code?(r(),K(V,{key:0,class:"px-3 py-2 border rounded-lg",onClick:O,disabled:f.value},{default:T(()=>[...s[9]||(s[9]=[g(" Remove ",-1)])]),_:1},8,["disabled"])):b("",!0)]),d.value?(r(),a("div",{key:0,class:G(["text-xs mt-1",x.value?"text-green-600":"text-red-600"])},u(d.value),3)):b("",!0)]),e("div",Xe,[s[11]||(s[11]=e("span",null,"Total",-1)),e("span",null,u(m(k.value.total_cents)),1)]),l.value?(r(),a("button",Qe,[...s[12]||(s[12]=[e("span",{class:"inline-block h-4 w-4 rounded-full border-2 border-current border-t-transparent animate-spin"},null,-1),g(" Redirecting… ",-1)])])):(r(),a("button",{key:0,class:"w-full mt-4 px-4 py-2 bg-primary text-primary-foreground rounded-lg",onClick:z}," Pay (DEV success) ")),i.value?(r(),a("button",Ze," Creating… ")):(r(),a("button",{key:2,class:"w-full mt-2 px-4 py-2 border rounded-lg",onClick:I}," Create test order (pending) ")),s[14]||(s[14]=e("div",{class:"mt-3 text-xs text-muted-foreground"},[g(" Use test card: "),e("code",null,"4242 4242 4242 4242"),g(", any future date, any CVC, any ZIP. ")],-1))])])])])]),_:1})],64))}});export{tt as default};
